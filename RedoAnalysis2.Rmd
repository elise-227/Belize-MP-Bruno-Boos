---
title: "Redo Analysis 2"
author: "Elise Boos"
date: "2024-01-14"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r packages, include=FALSE}
require(tidyverse)
#require(mapview)
require(sf)
require(raster)

require(snowfall)

#install.packages("rjags")
require(rjags)
library(camtrapR)
```


Workflow inspiration: https://jniedballa.github.io/camtrapR/articles/camtrapr5.html

# Run it back
```{r load data, include=FALSE}
#Load and Clean Data 

##load dfs
load("dat.RData")
load("camop.RData")
covs_all <- read.csv("covs_fin.csv",stringsAsFactors = TRUE)

#fix logging column
covs_all$Logging <- ifelse(covs_all$Logging %in% c("No", "No Logging"), "No", "Yes")

#another option to rewrite factor
#library(forcats)
#covs_all2$Logging_fix <- fct_collapse(covs_all2$Logging, No = c("No","No Logging"), Yes = c("Yes","Logging"))

#missing lat and long 
covs_all[covs_all$site =="908F",]$Lat <- 17.66851300
covs_all[covs_all$site =="908F",]$Long <- -89.01283000

```

```{r fix easting northing, include=FALSE}
# these sites missing easting northing 
# 508H <- 288991 , 1929840
# 502C <- 292758, 1955010
# 503C <- 291102, 1950731
# 506C <- 291308 , 1950725
# 511C <- 282077, 1935175
# 506F <- 283678, 1935452

camop[camop$site == "508H",]$Easting <- 288991
camop[camop$site == "508H",]$Northing <- 1929840

camop[camop$site == "502C",]$Easting <- 292758
camop[camop$site == "502C",]$Northing <- 1955010

camop[camop$site == "503C",]$Easting <- 291102
camop[camop$site == "503C",]$Northing <- 1950731

camop[camop$site == "506C",]$Easting <- 291308
camop[camop$site == "506C",]$Northing <- 1950725

camop[camop$site == "511C",]$Easting <- 282077
camop[camop$site == "511C",]$Northing <- 1935175

camop[camop$site == "506F",]$Easting <- 283678
camop[camop$site == "506F",]$Northing <- 1935452
```


### Elevation as a possible covariate ?
```{r elevation}
belize_dem <- raster("./belize_dem_crop.tif")
plot(belize_dem)
#plot(foo_trans$geometry, bg="transparent", add=TRUE)

#will need to extract by points if want to use
ex <- extract(belize_dem, foo_trans, method = 'bilinear', fun = mean, na.rm = TRUE, df =TRUE)
summary(ex$belize_dem_crop)
```


```{r create sample year column}

dat <- dat %>% mutate(Sample_Year = substr(site, 1,1))
#dat$Sample_Year
dat <- subset(dat, Sample_Year !="6")

dat[dat$Sample_Year == 4,]$Sample_Year <- "2014"
dat[dat$Sample_Year == 5,]$Sample_Year <- "2015"
dat[dat$Sample_Year == 7,]$Sample_Year <- "2017"
dat[dat$Sample_Year == 8,]$Sample_Year <- "2018"
dat[dat$Sample_Year == 9,]$Sample_Year <- "2019"
dat[dat$Sample_Year == 0,]$Sample_Year <- "2020"
dat[dat$Sample_Year == 1,]$Sample_Year <- "2020"

dat$Sample_Year <- as.factor(dat$Sample_Year)
```

```{r 2017 species, include=FALSE}

dat$Species <- as.character(dat$Species)

species_list <- c("Agouti", "Baird's Tapir", "Crested Guan", "Common Opossum", "Gray Fox", "Gray-headed Dove", "Great Curassow", "Jaguar", "Ocellated Turkey", "Ocelot", "Paca", "Puma", "Red Brocket Deer", "White-nosed Coati", "White-tailed Deer")
species_list

camop <- camop %>% mutate(Sample_Year = substr(site, 1,1))
#dat$Sample_Year
camop <- subset(camop, Sample_Year !="6")

cam_op <- cameraOperation(camop, stationCol = "site", setupCol = "Date.Placement", 
                             retrievalCol = "Last.record", occasionStartTime = 0 , 
                             dateFormat = "%Y-%m-%d", writecsv = FALSE)

dat2 <- dat[-c(13493,15059),]
1557,4439,4743,6066,
```

#Another function to make cool maps if we want detection maps for a couple species
```{r}
detectionMaps(CTtable = camop, recordTable = dat2, Xcol = "Northing", Ycol = "Easting", stationCol = "site", speciesCol = "Species", richnessPlot = T, speciesPlots = T, printLabels = T, plotR = T)

```

## 2017 Prelim Results

```{r run 2017 model, include=FALSE}
 DetHist_list <- lapply(species_list, FUN = function(x) {
   detectionHistory(recordTable = dat2, species = x,
                                       camOp = cam_op, output = "binary", stationCol = "site", 
                                       speciesCol = "Species", day1 ="station", 
                                       recordDateTimeCol = "date_time_obs", 
                                       recordDateTimeFormat =  "%Y-%m-%d %H.%M", 
                                       timeZone = "UTC", occasionLength = 1, 
                                       includeEffort = TRUE, scaleEffort = FALSE, 
                                       writecsv = FALSE)}
 )

 # assign species names to the list items
 names(DetHist_list) <- species_list
 #double check correct naming

covs_all <- covs_all %>% mutate(Sample_Year = substr(site, 1,1))

covs_all[covs_all$Sample_Year == 4,]$Sample_Year <- "2014"
covs_all[covs_all$Sample_Year == 5,]$Sample_Year <- "2015"
covs_all[covs_all$Sample_Year == 7,]$Sample_Year <- "2017"
covs_all[covs_all$Sample_Year == 8,]$Sample_Year <- "2018"
covs_all[covs_all$Sample_Year == 9,]$Sample_Year <- "2019"
covs_all[covs_all$Sample_Year == 0,]$Sample_Year <- "2020"
covs_all[covs_all$Sample_Year == 1,]$Sample_Year <- "2020"

covs_all$Logging <- as.factor(covs_all$Logging)
covs_all$Sample_Year <- as.factor(covs_all$Sample_Year)
 
 # note, DetHist_list is a list containing a list for each species
 ylist <- lapply(DetHist_list, FUN = function(x) x$detection_history)

data_list <- list(ylist    = ylist,
                   siteCovs = covs_all,
                   obsCovs  = list(effort = DetHist_list[[1]]$effort)) 

# text file to save the model
 modelfile1 <- tempfile(fileext = ".txt")
```

```{r model code 2017, echo=TRUE}
 mod.jags <- communityModel(data_list,
                            occuCovs = list(fixed = c("Sample_Year"),ranef = c("Logging")),
                            detCovsObservation = list(fixed = "effort"),
                            intercepts = list(det = "ranef", occu = "ranef"),
                            modelFile = modelfile1)
summary(mod.jags)

#will need to increase iterations and maybe chains when running for real
 fit.jags <- fit(mod.jags,
                 n.iter = 100,
                 n.burnin = 50,
                 chains = 1)
``` 


```{r model graphs for 2019, echo=FALSE}
 fit_summary <- summary(fit.jags)
 as.data.frame(fit_summary$statistics)
 
 #DT::datatable(round(fit_summary$statistics, 3))
 
  plot_effects(mod.jags,
              fit.jags,
              submodel = "state")
  
   plot_effects(mod.jags,
              fit.jags,
              submodel = "det")
   
    plot_coef(mod.jags,
           fit.jags,
           submodel = "state")

```